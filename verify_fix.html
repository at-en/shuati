<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­”æ¡ˆä¿®å¤éªŒè¯</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test { margin: 10px 0; padding: 10px; border: 1px solid #ccc; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        .result { margin-top: 10px; padding: 10px; background-color: #f8f9fa; }
    </style>
</head>
<body>
    <h1>ç­”æ¡ˆæ¯”è¾ƒä¿®å¤éªŒè¯å·¥å…·</h1>
    
    <div class="test info">
        <h3>æµ‹è¯•è¯´æ˜</h3>
        <p>æ­¤å·¥å…·ç”¨äºéªŒè¯ç­”æ¡ˆæ¯”è¾ƒé€»è¾‘çš„ä¿®å¤æ˜¯å¦æˆåŠŸã€‚</p>
        <p>è¯·ç¡®ä¿ç³»ç»Ÿå·²é‡æ–°ç¼–è¯‘å¹¶é‡å¯ã€‚</p>
    </div>
    
    <div class="test">
        <h3>æ­¥éª¤1: ç™»å½•ç³»ç»Ÿ</h3>
        <button onclick="testLogin()">æµ‹è¯•ç™»å½•</button>
        <div id="loginResult" class="result" style="display:none;"></div>
    </div>
    
    <div class="test">
        <h3>æ­¥éª¤2: è·å–æµ‹è¯•é¢˜ç›®</h3>
        <button onclick="getTestQuestion()">è·å–é¢˜ç›®</button>
        <div id="questionResult" class="result" style="display:none;"></div>
    </div>
    
    <div class="test">
        <h3>æ­¥éª¤3: æµ‹è¯•ç­”æ¡ˆæäº¤</h3>
        <button onclick="testAnswerSubmission()">æµ‹è¯•æ­£ç¡®ç­”æ¡ˆ</button>
        <button onclick="testWrongAnswer()">æµ‹è¯•é”™è¯¯ç­”æ¡ˆ</button>
        <div id="answerResult" class="result" style="display:none;"></div>
    </div>
    
    <div class="test">
        <h3>æ­¥éª¤4: éªŒè¯ç»“æœ</h3>
        <div id="finalResult" class="result" style="display:none;"></div>
    </div>
    
    <script>
        let testQuestion = null;
        let sessionCookie = null;
        
        async function testLogin() {
            const resultDiv = document.getElementById('loginResult');
            resultDiv.style.display = 'block';
            
            try {
                // å°è¯•æ³¨å†Œæµ‹è¯•ç”¨æˆ·
                const registerResponse = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: 'testuser_fix', password: 'test123' }),
                    credentials: 'include'
                });
                
                // ç™»å½•æµ‹è¯•ç”¨æˆ·
                const loginResponse = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: 'testuser_fix', password: 'test123' }),
                    credentials: 'include'
                });
                
                if (loginResponse.ok) {
                    const data = await loginResponse.json();
                    resultDiv.innerHTML = `âœ… ç™»å½•æˆåŠŸ: ${data.user.username}`;
                    resultDiv.className = 'result success';
                } else {
                    throw new Error('ç™»å½•å¤±è´¥');
                }
            } catch (error) {
                resultDiv.innerHTML = `âŒ ç™»å½•å¤±è´¥: ${error.message}`;
                resultDiv.className = 'result error';
            }
        }
        
        async function getTestQuestion() {
            const resultDiv = document.getElementById('questionResult');
            resultDiv.style.display = 'block';
            
            try {
                const response = await fetch('/api/questions?limit=1', {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.questions && data.questions.length > 0) {
                        testQuestion = data.questions[0];
                        const options = testQuestion.options ? testQuestion.options.split('|') : [];
                        
                        resultDiv.innerHTML = `
                            âœ… è·å–é¢˜ç›®æˆåŠŸ<br>
                            <strong>é¢˜ç›®:</strong> ${testQuestion.question}<br>
                            <strong>ç±»å‹:</strong> ${testQuestion.type}<br>
                            <strong>æ­£ç¡®ç­”æ¡ˆ:</strong> ${testQuestion.answer}<br>
                            <strong>é€‰é¡¹:</strong><br>
                            ${options.map(opt => `- ${opt}`).join('<br>')}
                        `;
                        resultDiv.className = 'result success';
                    } else {
                        throw new Error('æ²¡æœ‰è·å–åˆ°é¢˜ç›®');
                    }
                } else {
                    throw new Error('è·å–é¢˜ç›®å¤±è´¥');
                }
            } catch (error) {
                resultDiv.innerHTML = `âŒ è·å–é¢˜ç›®å¤±è´¥: ${error.message}`;
                resultDiv.className = 'result error';
            }
        }
        
        async function testAnswerSubmission() {
            if (!testQuestion) {
                alert('è¯·å…ˆè·å–æµ‹è¯•é¢˜ç›®');
                return;
            }
            
            const resultDiv = document.getElementById('answerResult');
            resultDiv.style.display = 'block';
            
            try {
                // æ„é€ æ­£ç¡®ç­”æ¡ˆï¼ˆå®Œæ•´æ ¼å¼ï¼‰
                const options = testQuestion.options ? testQuestion.options.split('|') : [];
                let correctAnswerFull = testQuestion.answer;
                
                // å¦‚æœæœ‰é€‰é¡¹ï¼Œæ‰¾åˆ°å¯¹åº”çš„å®Œæ•´é€‰é¡¹
                if (options.length > 0) {
                    const correctOption = options.find(opt => opt.startsWith(testQuestion.answer + '.'));
                    if (correctOption) {
                        correctAnswerFull = correctOption;
                    }
                }
                
                const response = await fetch('/api/questions/submit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        question_id: testQuestion.id,
                        answer: correctAnswerFull
                    }),
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const status = data.is_correct ? 'âœ… æ­£ç¡®' : 'âŒ é”™è¯¯';
                    
                    resultDiv.innerHTML = `
                        ${status} ç­”æ¡ˆæäº¤æµ‹è¯•ç»“æœ<br>
                        <strong>æäº¤çš„ç­”æ¡ˆ:</strong> ${correctAnswerFull}<br>
                        <strong>æ­£ç¡®ç­”æ¡ˆ:</strong> ${data.correct_answer}<br>
                        <strong>åˆ¤æ–­ç»“æœ:</strong> ${data.is_correct ? 'æ­£ç¡®' : 'é”™è¯¯'}<br>
                        <strong>ä¿®å¤çŠ¶æ€:</strong> ${data.is_correct ? 'âœ… ä¿®å¤æˆåŠŸ' : 'âŒ ä»æœ‰é—®é¢˜'}
                    `;
                    resultDiv.className = data.is_correct ? 'result success' : 'result error';
                    
                    // æ›´æ–°æœ€ç»ˆç»“æœ
                    updateFinalResult(data.is_correct);
                } else {
                    throw new Error('æäº¤ç­”æ¡ˆå¤±è´¥');
                }
            } catch (error) {
                resultDiv.innerHTML = `âŒ æµ‹è¯•å¤±è´¥: ${error.message}`;
                resultDiv.className = 'result error';
            }
        }
        
        async function testWrongAnswer() {
            if (!testQuestion) {
                alert('è¯·å…ˆè·å–æµ‹è¯•é¢˜ç›®');
                return;
            }
            
            try {
                // æäº¤ä¸€ä¸ªé”™è¯¯ç­”æ¡ˆ
                const wrongAnswer = testQuestion.answer === 'A' ? 'B. é”™è¯¯é€‰é¡¹' : 'A. é”™è¯¯é€‰é¡¹';
                
                const response = await fetch('/api/questions/submit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        question_id: testQuestion.id,
                        answer: wrongAnswer
                    }),
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('é”™è¯¯ç­”æ¡ˆæµ‹è¯•:', data.is_correct ? 'åº”è¯¥æ˜¯é”™è¯¯ä½†æ˜¾ç¤ºæ­£ç¡®' : 'æ­£ç¡®æ˜¾ç¤ºä¸ºé”™è¯¯');
                }
            } catch (error) {
                console.error('é”™è¯¯ç­”æ¡ˆæµ‹è¯•å¤±è´¥:', error);
            }
        }
        
        function updateFinalResult(isFixed) {
            const resultDiv = document.getElementById('finalResult');
            resultDiv.style.display = 'block';
            
            if (isFixed) {
                resultDiv.innerHTML = `
                    ğŸ‰ <strong>ä¿®å¤éªŒè¯æˆåŠŸï¼</strong><br>
                    ç­”æ¡ˆæ¯”è¾ƒé€»è¾‘å·²æ­£ç¡®ä¿®å¤ï¼Œç³»ç»Ÿç°åœ¨èƒ½å¤Ÿæ­£ç¡®å¤„ç†å®Œæ•´æ ¼å¼çš„é€‰é¡¹ç­”æ¡ˆã€‚
                `;
                resultDiv.className = 'result success';
            } else {
                resultDiv.innerHTML = `
                    âš ï¸ <strong>ä¿®å¤éªŒè¯å¤±è´¥</strong><br>
                    ç­”æ¡ˆæ¯”è¾ƒé€»è¾‘ä»æœ‰é—®é¢˜ï¼Œè¯·æ£€æŸ¥ä»£ç ä¿®æ”¹æ˜¯å¦æ­£ç¡®åº”ç”¨ï¼Œå¹¶ç¡®ä¿ç³»ç»Ÿå·²é‡æ–°ç¼–è¯‘å’Œé‡å¯ã€‚
                `;
                resultDiv.className = 'result error';
            }
        }
    </script>
</body>
</html>